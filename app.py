import streamlit as st
import tensorflow as tf
from PIL import Image, ImageOps
import numpy as np
import os

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(
    page_title="Chili Doctor AI",
    page_icon="üå∂Ô∏è",
    layout="centered"
)

# --- üé® ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á CSS (‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏™‡∏î‡πÉ‡∏™ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Portal) ---
st.markdown("""
<style>
    /* ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå Prompt */
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap');
    
    /* 1. ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: ‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÅ‡∏î‡∏á‡∏™‡∏î‡πÉ‡∏™ (‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ HTML Portal) */
    .stApp {
        background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
        font-family: 'Prompt', sans-serif;
        color: #333333;
    }

    /* 2. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏£‡∏∞‡∏à‡∏Å (Glassmorphism) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô .glass-card */
    .main .block-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 24px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö HTML */
        padding: 2.5rem;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); /* ‡πÄ‡∏á‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö HTML */
        max-width: 700px;
        margin-top: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ */
    h1 {
        color: #333; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
        font-weight: 600;
        text-align: center;
        padding-bottom: 0.5rem;
    }
    
    #MainMenu {visibility: hidden;}
    header {visibility: hidden;}
    footer {visibility: hidden;}
    
    /* 3. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î: ‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÅ‡∏î‡∏á */
    div.stButton > button {
        background: linear-gradient(90deg, #FF416C 0%, #FF4B2B 100%);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 0.6rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
    }
    div.stButton > button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 65, 108, 0.6);
        background: linear-gradient(90deg, #ff5b7a 0%, #ff6b4b 100%);
        color: white;
    }
    
    /* 4. File Uploader: ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á */
    .stFileUploader {
        border: 2px dashed #FF4B2B;
        border-radius: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.5);
        transition: border-color 0.3s;
    }
    .stFileUploader:hover {
        border-color: #c0392b;
        background-color: rgba(255, 255, 255, 0.8);
    }
    
    /* Custom Header Style */
    .custom-header {
        text-align: center;
        margin-bottom: 35px;
    }
    .app-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px;
        margin: 0 auto 20px;
        box-shadow: 0 4px 15px rgba(255, 75, 43, 0.3);
        animation: pulse 2s infinite;
    }
    .subtitle {
        color: #d32f2f;
        font-weight: 500;
        font-size: 0.9rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    
    .stAlert {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 75, 43, 0.4); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 75, 43, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 75, 43, 0); }
    }
</style>
""", unsafe_allow_html=True)

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ---
@st.cache_resource
def load_model():
    filename = 'efficientnetb4_model.h5'
    
    if not os.path.exists(filename):
        file_id = '1tURhAR8mXLAgnuU3EULswpcFGxnalWAV'
        url = f'https://drive.google.com/uc?id={file_id}'
        
        # ‡πÉ‡∏ä‡πâ container ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡πÜ
        with st.status("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏≤‡∏Å Cloud... (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)", expanded=True) as status:
            try:
                import gdown
                gdown.download(url, filename, quiet=False)
                if os.path.exists(filename):
                    status.update(label="‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", state="complete", expanded=False)
                else:
                    status.update(label="‚ùå ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", state="error")
                    return None
            except Exception as e:
                status.update(label=f"‚ùå Error: {e}", state="error")
                return None

    try:
        model = tf.keras.models.load_model(filename)
        return model
    except Exception as e:
        st.error(f"‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: {e}")
        return None

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ ---
def import_and_predict(image_data, model):
    size = (300, 300)
    image = ImageOps.fit(image_data, size, Image.Resampling.LANCZOS)
    img_array = np.asarray(image)
    img_array = img_array.astype(np.float32) 
    
    data = np.ndarray(shape=(1, 300, 300, 3), dtype=np.float32)
    data[0] = img_array
    
    prediction = model.predict(data)
    return prediction

# --- 4. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (UI) ---

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏ö‡∏ö Custom HTML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Portal
st.markdown("""
    <div class="custom-header">
        <div class="app-icon">üå∂Ô∏è</div>
        <div class="subtitle">AI Expert System</div>
        <h1 style="margin-top: 0; color: #333;">Chili Doctor AI</h1>
    </div>
""", unsafe_allow_html=True)

st.markdown("""
<p style="text-align: center; color: #555; margin-bottom: 30px; line-height: 1.6;">
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡πÉ‡∏ö <br>
    <span style="font-size: 0.9rem; color: #888;">(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ö‡∏û‡∏£‡∏¥‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)</span>
</p>
""", unsafe_allow_html=True)

# ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
model = load_model()

if model is None:
    st.stop()

class_names = ['healthy', 'leaf curl', 'leaf spot', 'whitefly', 'yellow']

# ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
file = st.file_uploader("", type=["jpg", "png", "jpeg"])

if file is None:
    st.info("üëÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (.jpg, .png) ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
else:
    image = Image.open(file)
    # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏°‡∏∏‡∏°‡∏°‡∏ô
    st.markdown('<div style="text-align: center;">', unsafe_allow_html=True)
    st.image(image, use_container_width=True)
    st.markdown('</div>', unsafe_allow_html=True)
    
    # ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
    st.markdown("<br>", unsafe_allow_html=True)
    
    if st.button("üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏£‡∏Ñ"):
        with st.spinner('AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'):
            predictions = import_and_predict(image, model)
            class_index = np.argmax(predictions)
            result_class = class_names[class_index]
            confidence = np.max(predictions) * 100

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î Alert ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≠‡∏•
        st.markdown("<hr style='border-top: 1px solid #eee; margin: 30px 0;'>", unsafe_allow_html=True)
        st.markdown(f"""
            <div style="background-color: #f0fff4; border: 1px solid #c3e6cb; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px;">
                <h4 style="margin:0; color: #155724; font-weight: 600;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: <span style="font-size: 1.4rem;">{result_class}</span></h4>
            </div>
            <p style="text-align: center; color: #6c757d; font-size: 0.9rem;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (Confidence): <b>{confidence:.2f}%</b></p>
        """, unsafe_allow_html=True)

        # ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        treatment_text = ""
        treatment_bg = "#fff8e1" # ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡πÜ
        treatment_border = "#ffeeba"
        text_color = "#856404"

        if result_class == 'healthy':
            treatment_text = "‚úÖ **‡∏ï‡πâ‡∏ô‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏î‡∏µ!** ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ ‡∏´‡∏°‡∏±‡πà‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥"
            treatment_bg = "#d4edda" # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
            treatment_border = "#c3e6cb"
            text_color = "#155724"
        elif result_class == 'leaf curl':
            treatment_text = "‚ö†Ô∏è **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏´‡∏á‡∏¥‡∏Å‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏ß‡∏µ‡πà‡∏Ç‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏™‡∏∞‡πÄ‡∏î‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡πÄ‡∏°‡∏ï‡∏≤‡πÑ‡∏£‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô"
        elif result_class == 'leaf spot':
            treatment_text = "‚ö†Ô∏è **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏Å‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ú‡∏≤‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤"
        elif result_class == 'whitefly':
             treatment_text = "‚ö†Ô∏è **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏ß‡∏µ‡πà‡∏Ç‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏Å‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏°‡∏±‡∏Å‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£"
        elif result_class == 'yellow':
             treatment_text = "‚ö†Ô∏è **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á"
             
        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤
        st.markdown(f"""
            <div style="background-color: {treatment_bg}; color: {text_color}; padding: 18px; border-radius: 12px; border: 1px solid {treatment_border}; line-height: 1.6;">
                {treatment_text}
            </div>
        """, unsafe_allow_html=True)

# Footer ‡∏™‡∏ß‡∏¢‡πÜ
st.markdown("""
<div style="text-align: center; margin-top: 60px; color: #e0e0e0; font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 20px;">
    ‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‚Ä¢ ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ<br>
    <span style="font-size: 0.75rem;">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢: ‡πÅ‡∏°‡∏ß‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏ó‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ú‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</span>
</div>
""", unsafe_allow_html=True)