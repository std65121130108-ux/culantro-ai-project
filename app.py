import streamlit as st
import tensorflow as tf
from PIL import Image, ImageOps
import numpy as np
import os

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(
    page_title="Chili Doctor AI",
    page_icon="üå∂Ô∏è",
    layout="centered"
)

# --- 2. üé® CSS ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á (Clean White Theme - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö) ---
st.markdown("""
<style>
    /* ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå Prompt */
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
    
    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
    html, body, [class*="css"] {
        font-family: 'Prompt', sans-serif;
        color: #333;
    }
    
    /* 1. ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤ (White Background) */
    .stApp {
        background-color: #ffffff;
        background-image: radial-gradient(#ff4b2b 0.5px, transparent 0.5px);
        background-size: 20px 20px; /* ‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏á‡πÜ ‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÑ‡∏°‡πà‡πÇ‡∏•‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
        opacity: 1;
    }

    /* 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Layout ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πà‡∏á */
    .block-container {
        padding-top: 3rem;
        padding-bottom: 3rem;
        max-width: 700px;
    }
    
    /* 3. ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Header) */
    .header-container {
        text-align: center;
        margin-bottom: 40px;
    }
    .app-icon {
        font-size: 60px;
        margin-bottom: 10px;
        display: inline-block;
        animation: float 3s ease-in-out infinite;
    }
    .app-title {
        font-weight: 800;
        font-size: 2.5rem;
        background: linear-gradient(90deg, #FF416C 0%, #FF4B2B 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
        padding: 0;
        letter-spacing: -1px;
    }
    .app-subtitle {
        color: #666;
        font-weight: 500;
        font-size: 1.1rem;
        margin-top: 10px;
    }
    
    /* 4. ‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (File Uploader) - ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö */
    [data-testid="stFileUploaderDropzone"] {
        background-color: #FAFAFA !important;
        border: 2px dashed #FF4B2B !important;
        border-radius: 20px !important;
        padding: 30px !important;
        transition: all 0.3s;
    }
    [data-testid="stFileUploaderDropzone"]:hover {
        background-color: #FFF0F0 !important;
        transform: scale(1.01);
    }
    [data-testid="stFileUploaderDropzone"] div div::before {
        content: "üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏û‡∏£‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà";
        color: #555;
        font-weight: 600;
        font-size: 1rem;
    }
    
    /* 5. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (Button) */
    div.stButton > button {
        background: linear-gradient(90deg, #FF416C 0%, #FF4B2B 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 50px !important;
        padding: 15px 30px !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        width: 100% !important;
        box-shadow: 0 10px 20px rgba(255, 75, 43, 0.3) !important;
        transition: all 0.3s ease !important;
    }
    div.stButton > button:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(255, 75, 43, 0.5) !important;
    }
    
    /* 6. Footer */
    .footer {
        text-align: center;
        margin-top: 50px;
        color: #999;
        font-size: 0.8rem;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }
    
    /* Animation */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    /* ‡∏ã‡πà‡∏≠‡∏ô Header/Footer ‡πÄ‡∏î‡∏¥‡∏° */
    #MainMenu {visibility: hidden;}
    header {visibility: hidden;}
    footer {visibility: hidden;}
</style>
""", unsafe_allow_html=True)

# --- 3. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ---
@st.cache_resource
def load_model():
    filename = 'efficientnetb4_model.h5'
    if not os.path.exists(filename):
        file_id = '1tURhAR8mXLAgnuU3EULswpcFGxnalWAV'
        url = f'https://drive.google.com/uc?id={file_id}'
        with st.status("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...", expanded=True) as status:
            try:
                import gdown
                gdown.download(url, filename, quiet=False)
                if os.path.exists(filename):
                    status.update(label="‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!", state="complete", expanded=False)
                else:
                    return None
            except:
                return None
    try:
        return tf.keras.models.load_model(filename)
    except:
        return None

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
def import_and_predict(image_data, model):
    size = (300, 300)
    image = ImageOps.fit(image_data, size, Image.Resampling.LANCZOS)
    img_array = np.asarray(image).astype(np.float32)
    data = np.ndarray(shape=(1, 300, 300, 3), dtype=np.float32)
    data[0] = img_array
    return model.predict(data)

# --- 4. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (UI) ---

model = load_model()

# 1. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) - ‡∏ß‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
st.markdown("""
    <div class="header-container">
        <div class="app-icon">üå∂Ô∏è</div>
        <h1 class="app-title">Chili Doctor AI</h1>
        <p class="app-subtitle">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ‡∏û‡∏£‡∏¥‡∏Å‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞<br>
            <span style="font-size: 0.9rem; color: #999;">Deep Learning Technology (EfficientNetB4)</span>
        </p>
    </div>
""", unsafe_allow_html=True)

# 2. ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (File Uploader) - ‡∏ß‡∏≤‡∏á‡πÇ‡∏•‡πà‡∏á‡πÜ
file = st.file_uploader("", type=["jpg", "png", "jpeg"])

# ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
if file is None:
    st.markdown("""
        <div style="text-align: center; color: #bbb; margin-top: 10px; font-size: 0.9rem;">
            ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 200MB)
        </div>
    """, unsafe_allow_html=True)

# 3. ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Result)
if file is not None:
    image = Image.open(file)
    
    st.markdown("<br>", unsafe_allow_html=True)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á)
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.image(image, use_container_width=True)
        
    # ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
    if st.button("üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏£‡∏Ñ"):
        if model is None:
            st.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏î‡πâ")
        else:
            with st.spinner('ü§ñ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...'):
                predictions = import_and_predict(image, model)
                class_names = ['healthy', 'leaf curl', 'leaf spot', 'whitefly', 'yellow']
                class_index = np.argmax(predictions)
                result_class = class_names[class_index]
                confidence = np.max(predictions) * 100

            st.markdown("<hr style='margin: 30px 0; border-top: 1px solid #eee;'>", unsafe_allow_html=True)
            
            # ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            st.markdown(f"""
                <div style="text-align: center;">
                    <h3 style="color: #555; margin: 0; font-size: 1.2rem;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
                    <h1 style="background: linear-gradient(90deg, #FF416C 0%, #FF4B2B 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 3rem; margin: 10px 0; font-weight: 800;">{result_class}</h1>
                    <div style="display: inline-block; background: #f0f0f0; padding: 5px 15px; border-radius: 20px; color: #555; font-size: 0.9rem;">
                        ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <b>{confidence:.2f}%</b>
                    </div>
                </div>
            """, unsafe_allow_html=True)

            # ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            treatment_text = ""
            bg_color = "#FFF8E1" # ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
            text_color = "#FF6F00"
            border_color = "#FFECB3"
            icon = "üí°"
            
            if result_class == 'healthy':
                treatment_text = "‡∏ï‡πâ‡∏ô‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏î‡∏µ! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ ‡∏´‡∏°‡∏±‡πà‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥"
                bg_color = "#E8F5E9"
                text_color = "#2E7D32"
                border_color = "#C8E6C9"
                icon = "üåø"
            elif result_class == 'leaf curl':
                treatment_text = "‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏´‡∏á‡∏¥‡∏Å‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏ß‡∏µ‡πà‡∏Ç‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏™‡∏∞‡πÄ‡∏î‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡πÄ‡∏°‡∏ï‡∏≤‡πÑ‡∏£‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô"
            elif result_class == 'leaf spot':
                treatment_text = "‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏Å‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ú‡∏≤‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤"
            elif result_class == 'whitefly':
                 treatment_text = "‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏ß‡∏µ‡πà‡∏Ç‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏Å‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏°‡∏±‡∏Å‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£"
            elif result_class == 'yellow':
                 treatment_text = "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á"
            
            st.markdown(f"""
                <div style="background-color: {bg_color}; color: {text_color}; padding: 25px; border-radius: 20px; margin-top: 25px; border: 1px solid {border_color}; line-height: 1.6; text-align: left;">
                    <strong style="display: block; margin-bottom: 5px; font-size: 1.1rem;">{icon} ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong>
                    {treatment_text}
                </div>
            """, unsafe_allow_html=True)

# 4. Footer
st.markdown("""
    <div class="footer">
        ‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‚Ä¢ ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ<br>
        ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢: ‡πÅ‡∏°‡∏ß‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏ó‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ú‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
    </div>
""", unsafe_allow_html=True)